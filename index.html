<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SampleTrack â€” Free Sample Management</title>
<script>
// Load MSAL from local file with proper onload handling
(function() {
  const s = document.createElement('script');
  s.src = 'msal.min.js';
  s.onload = function() {
    console.log('[MSAL] msal.min.js loaded successfully');
    initMSAL();
  };
  s.onerror = function() {
    console.error('[MSAL] Failed to load msal.min.js');
    document.getElementById('msalLoadError').style.display = 'flex';
    document.getElementById('loginScreen').style.display = 'none';
  };
  document.head.appendChild(s);
})();
</script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Epilogue:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --ink:#0c1220;--ink2:#2d3a52;--ink3:#5c6b82;--ink4:#9aaabb;
  --surface:#f4f6fa;--surface2:#eaecf3;--white:#ffffff;
  --teal:#00c39a;--teal-dim:#e5faf5;--teal-dark:#009e7c;
  --amber:#f5a623;--amber-dim:#fff4e0;
  --red:#e84545;--red-dim:#fdeaea;
  --blue:#2f80ed;--blue-dim:#e8f1fd;
  --violet:#7c3aed;--violet-dim:#f3eeff;
  --msblue:#0078d4;
  --r:10px;--sh:0 2px 14px rgba(12,18,32,.08);--sh2:0 6px 30px rgba(12,18,32,.13);
}
body{font-family:'Epilogue',sans-serif;background:var(--surface);color:var(--ink);min-height:100vh;font-size:14px;line-height:1.5}

/* â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loginScreen{
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;background:var(--ink);
  background-image:radial-gradient(ellipse at 20% 50%,rgba(0,195,154,.12) 0%,transparent 60%),
                   radial-gradient(ellipse at 80% 20%,rgba(47,128,237,.08) 0%,transparent 50%);
}
.login-card{
  background:rgba(255,255,255,.04);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,.08);border-radius:20px;
  padding:48px 52px;width:440px;text-align:center;
}
.login-logo{width:56px;height:56px;background:var(--teal);border-radius:14px;
  display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 20px;}
.login-title{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;color:#fff;letter-spacing:-.03em;margin-bottom:6px}
.login-sub{color:rgba(255,255,255,.45);font-size:13.5px;margin-bottom:36px;line-height:1.6}
.login-divider{border:none;border-top:1px solid rgba(255,255,255,.08);margin:28px 0}
.login-note{font-size:12px;color:rgba(255,255,255,.3);margin-top:20px;line-height:1.6}
.btn-ms{
  display:flex;align-items:center;justify-content:center;gap:12px;
  width:100%;padding:14px 20px;border-radius:10px;border:none;cursor:pointer;
  background:#fff;color:var(--ink);font-family:'Syne',sans-serif;
  font-size:14px;font-weight:700;transition:.15s;letter-spacing:.01em;
}
.btn-ms:hover{background:#f0f4ff;transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.btn-ms:disabled{opacity:.5;cursor:not-allowed;transform:none}
.ms-logo{width:20px;height:20px;flex-shrink:0}
.login-config-note{
  background:rgba(245,166,35,.1);border:1px solid rgba(245,166,35,.25);
  border-radius:8px;padding:12px 14px;margin-bottom:24px;text-align:left;
}
.login-config-note .cn-title{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--amber);margin-bottom:4px}
.login-config-note .cn-body{font-size:12px;color:rgba(255,255,255,.5);line-height:1.6}
.login-config-note code{font-family:'JetBrains Mono',monospace;font-size:11px;color:rgba(255,255,255,.7);background:rgba(255,255,255,.06);padding:1px 5px;border-radius:4px}

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loadingScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--surface);flex-direction:column;gap:14px}
.spinner{width:36px;height:36px;border:3px solid var(--surface2);border-top-color:var(--teal);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'Syne',sans-serif;font-size:13px;font-weight:600;color:var(--ink3)}

/* â”€â”€ SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#appShell{display:none}
#shell{display:flex;min-height:100vh}
.sidebar{width:252px;background:var(--ink);min-height:100vh;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200}
.main{margin-left:252px;flex:1;display:flex;flex-direction:column}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sb-logo{padding:18px 16px 16px;border-bottom:1px solid rgba(255,255,255,.07)}
.sb-logo-inner{display:flex;align-items:center;gap:10px}
.sb-logo-icon{width:34px;height:34px;background:var(--teal);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.sb-logo-text{color:#fff;font-size:12px;font-weight:700;letter-spacing:-.01em;font-family:'Syne',sans-serif}
.sb-logo-sub{color:var(--ink4);font-size:10px}
.sb-user{margin:12px 12px 0;background:rgba(255,255,255,.06);border-radius:9px;padding:10px 12px;display:flex;align-items:center;gap:10px}
.sb-avatar{width:32px;height:32px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.sb-user-name{color:#fff;font-size:12px;font-weight:600;font-family:'Syne',sans-serif;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px}
.sb-user-role{color:var(--ink4);font-size:10px}
.sb-nav{flex:1;padding:14px 10px;overflow-y:auto}
.sb-nav-section{margin-bottom:18px}
.sb-nav-label{color:var(--ink4);font-size:9.5px;text-transform:uppercase;letter-spacing:.12em;padding:0 10px;margin-bottom:6px;font-weight:600;font-family:'Syne',sans-serif}
.nav-btn{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;color:var(--ink4);font-size:13px;font-weight:500;transition:.15s;user-select:none;border:none;background:transparent;width:100%;text-align:left;font-family:'Epilogue',sans-serif}
.nav-btn:hover{background:rgba(255,255,255,.07);color:#fff}
.nav-btn.active{background:var(--teal);color:#fff}
.nav-btn.disabled{opacity:.35;cursor:not-allowed;pointer-events:none}
.nic{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nb{margin-left:auto;background:var(--red);color:#fff;font-size:10px;font-weight:700;border-radius:10px;padding:1px 7px;font-family:'Syne',sans-serif}
.nav-btn.active .nb{background:rgba(255,255,255,.28)}
.sb-footer{padding:12px;border-top:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:space-between}
.sb-footer-text{color:var(--ink4);font-size:10px}
.btn-signout{background:rgba(255,255,255,.06);border:none;border-radius:6px;padding:5px 10px;color:var(--ink4);font-size:11px;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;transition:.15s}
.btn-signout:hover{background:rgba(255,255,255,.12);color:#fff}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{background:var(--white);border-bottom:1px solid var(--surface2);height:58px;display:flex;align-items:center;justify-content:space-between;padding:0 28px;position:sticky;top:0;z-index:100}
.topbar-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--ink);letter-spacing:-.02em}
.topbar-right{display:flex;align-items:center;gap:10px}
.role-pill{font-size:10.5px;font-weight:700;padding:4px 11px;border-radius:20px;text-transform:uppercase;letter-spacing:.07em;font-family:'Syne',sans-serif}
.role-pill.sales{background:var(--teal-dim);color:var(--teal-dark)}
.role-pill.asm{background:var(--violet-dim);color:var(--violet)}
.role-pill.rsm{background:var(--blue-dim);color:var(--blue)}
.role-pill.admin{background:#fff0e0;color:#b06000}
.sp-badge{background:var(--surface2);color:var(--ink3);font-size:10px;font-weight:600;padding:3px 9px;border-radius:20px;font-family:'Syne',sans-serif;display:flex;align-items:center;gap:5px}
.sp-badge.live{background:#e0f7ef;color:#0a7a50}
.sp-badge.local{background:#fff8e0;color:#c08000}

/* â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{padding:26px 28px;flex:1}
.page{display:none}
.page.active{display:block;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.stat{background:var(--white);border-radius:var(--r);padding:18px 20px;box-shadow:var(--sh);border-left:4px solid transparent;transition:.15s;cursor:default}
.stat:hover{transform:translateY(-2px);box-shadow:var(--sh2)}
.stat.c-teal{border-color:var(--teal)}.stat.c-amber{border-color:var(--amber)}.stat.c-blue{border-color:var(--blue)}.stat.c-violet{border-color:var(--violet)}
.stat-label{font-size:10.5px;color:var(--ink3);font-weight:600;text-transform:uppercase;letter-spacing:.09em;font-family:'Syne',sans-serif}
.stat-val{font-size:30px;font-weight:800;font-family:'Syne',sans-serif;color:var(--ink);margin:3px 0 1px;line-height:1}
.stat-sub{font-size:11px;color:var(--ink4)}

/* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--white);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-bottom:20px}
.card-head{padding:15px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--surface2)}
.card-title{font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;color:var(--ink)}

/* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{padding:9px 16px;background:var(--surface);text-align:left;font-size:10.5px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;font-family:'Syne',sans-serif}
tbody tr{border-bottom:1px solid var(--surface2);transition:.12s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--surface)}
td{padding:12px 16px;font-size:13px;color:var(--ink2);vertical-align:middle}
td.mono{font-family:'JetBrains Mono',monospace;font-size:11.5px;color:var(--ink);font-weight:500}
.es{text-align:center;padding:40px 20px;color:var(--ink4);font-size:13px}
.es-icon{font-size:32px;margin-bottom:8px}

/* â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;font-family:'Syne',sans-serif}
.badge::before{content:'â—';font-size:7px}
.badge.pending{background:#fff8e0;color:#c08000}
.badge.asm-approved{background:var(--blue-dim);color:var(--blue)}
.badge.fully-approved{background:var(--teal-dim);color:var(--teal-dark)}
.badge.rejected{background:var(--red-dim);color:var(--red)}
.badge.sap-linked{background:#e5edff;color:#1a56db}
.badge.converted{background:#e0f7ef;color:#0a7a50}
.badge.not-converted{background:var(--surface2);color:var(--ink3)}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{padding:8px 16px;border-radius:8px;font-family:'Syne',sans-serif;font-size:12.5px;font-weight:700;cursor:pointer;border:none;transition:.15s;display:inline-flex;align-items:center;gap:6px;letter-spacing:.02em}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-primary{background:var(--teal);color:#fff}.btn-primary:hover:not(:disabled){background:var(--teal-dark)}
.btn-ghost{background:var(--surface);color:var(--ink2)}.btn-ghost:hover:not(:disabled){background:var(--surface2)}
.btn-approve{background:var(--teal-dim);color:var(--teal-dark)}.btn-approve:hover:not(:disabled){background:#c3f2e5}
.btn-rej{background:var(--red-dim);color:var(--red)}.btn-rej:hover:not(:disabled){background:#fcd0d0}
.btn-sm{padding:5px 11px;font-size:11.5px}
.btn-icon{padding:7px;border-radius:7px}

/* â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-inp{padding:7px 12px;border:1.5px solid var(--surface2);border-radius:8px;font-family:'Epilogue',sans-serif;font-size:13px;color:var(--ink);outline:none;width:200px;transition:.15s;background:var(--white)}
.search-inp:focus{border-color:var(--teal)}
.fsel{padding:7px 11px;border:1.5px solid var(--surface2);border-radius:8px;font-family:'Epilogue',sans-serif;font-size:13px;color:var(--ink);outline:none;cursor:pointer;background:var(--white)}
.fsel:focus{border-color:var(--teal)}
input[type=text],input[type=number],select,textarea{padding:9px 12px;border:1.5px solid var(--surface2);border-radius:8px;font-family:'Epilogue',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:.15s;background:var(--white);width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--teal)}
textarea{resize:vertical;min-height:70px}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(12,18,32,.45);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:.2s ease}
.mo.open{opacity:1;pointer-events:all}
.md{background:var(--white);border-radius:14px;width:100%;max-width:640px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(12,18,32,.22);transform:translateY(12px);transition:.2s ease}
.mo.open .md{transform:translateY(0)}
.md-lg{max-width:820px}
.md-head{padding:20px 24px;border-bottom:1px solid var(--surface2);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--white);z-index:5}
.md-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--ink)}
.md-close{background:var(--surface);border:none;border-radius:7px;width:30px;height:30px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;color:var(--ink3);transition:.15s}
.md-close:hover{background:var(--surface2)}
.md-body{padding:24px}
.md-foot{padding:16px 24px;border-top:1px solid var(--surface2);display:flex;justify-content:flex-end;gap:10px;background:var(--surface)}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.fg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.fs{margin-bottom:22px}
.fs-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--ink3);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--surface2)}
.fg{display:flex;flex-direction:column;gap:5px}
label.fl{font-size:12px;font-weight:600;color:var(--ink2);font-family:'Syne',sans-serif}
.req{color:var(--red)}
.pr{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:8px}
.add-row{margin-top:4px;background:var(--surface);border:1.5px dashed var(--surface2);border-radius:8px;padding:8px;color:var(--ink3);cursor:pointer;font-family:'Syne',sans-serif;font-size:12px;font-weight:600;width:100%;text-align:center;transition:.15s}
.add-row:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}

/* â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.di{background:var(--surface);border-radius:8px;padding:12px 14px}
.dl{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--ink4);font-family:'Syne',sans-serif;margin-bottom:3px}
.dv{font-size:13px;color:var(--ink);font-weight:500}
.df{grid-column:1/-1}
.sdiv{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--ink3);margin:18px 0 10px;padding-bottom:7px;border-bottom:1px solid var(--surface2)}

/* â”€â”€ TIMELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tl{display:flex;flex-direction:column}
.tli{display:flex;gap:14px;position:relative;padding-bottom:16px}
.tli:last-child{padding-bottom:0}
.tl-line{position:absolute;left:14px;top:28px;bottom:0;width:2px;background:var(--surface2)}
.tli:last-child .tl-line{display:none}
.tld{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;z-index:1}
.tld.done{background:var(--teal);color:#fff}.tld.pend{background:var(--amber-dim);color:var(--amber)}
.tld.rej{background:var(--red-dim);color:var(--red)}.tld.gray{background:var(--surface2);color:var(--ink4)}
.tlc{flex:1;padding-top:3px}
.tlt{font-family:'Syne',sans-serif;font-size:12.5px;font-weight:700;color:var(--ink);margin-bottom:1px}
.tls{font-size:11.5px;color:var(--ink4)}

/* â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prog{display:flex;margin-bottom:24px}
.ps{flex:1;text-align:center;position:relative}
.ps:not(:last-child)::after{content:'';position:absolute;top:12px;left:50%;right:-50%;height:2px;background:var(--surface2);z-index:0}
.ps.done:not(:last-child)::after{background:var(--teal)}
.ps.rejected:not(:last-child)::after{background:var(--red)}
.pd{width:26px;height:26px;border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;position:relative;z-index:1;font-family:'Syne',sans-serif}
.pd.done{background:var(--teal);color:#fff}.pd.active{background:var(--amber);color:#fff}
.pd.inactive{background:var(--surface2);color:var(--ink4)}.pd.rejected{background:var(--red);color:#fff}
.pl{font-family:'Syne',sans-serif;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink3)}
.ps.done .pl{color:var(--teal-dark)}.ps.active .pl{color:var(--amber)}.ps.rejected .pl{color:var(--red)}

/* â”€â”€ REJECTION NOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rnote{background:var(--red-dim);border-radius:8px;padding:12px 14px;margin-bottom:16px;display:flex;gap:10px}
.rnote-icon{font-size:16px;flex-shrink:0;margin-top:1px}
.rnote-text{font-size:12.5px;color:var(--red);line-height:1.5}

/* â”€â”€ REMINDER BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rbanner{background:linear-gradient(135deg,var(--ink) 0%,var(--ink2) 100%);border-radius:var(--r);padding:18px 22px;margin-bottom:20px;display:flex;align-items:center;gap:16px;color:#fff}
.rbi{font-size:26px;flex-shrink:0}
.rbt{flex:1}
.rbt-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:2px}
.rbt-sub{font-size:12.5px;color:rgba(255,255,255,.6)}

/* â”€â”€ ADMIN PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.admin-notice{background:linear-gradient(135deg,#1a0f38 0%,#2d1a5e 100%);border-radius:var(--r);padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;gap:16px;color:#fff;border:1px solid rgba(124,58,237,.3)}
.user-avatar-sm{width:34px;height:34px;border-radius:50%;background:var(--violet);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.role-select-inline{padding:5px 10px;border:1.5px solid var(--surface2);border-radius:7px;font-family:'Syne',sans-serif;font-size:12px;font-weight:600;color:var(--ink);outline:none;cursor:pointer;background:var(--white)}
.role-select-inline:focus{border-color:var(--violet)}

/* â”€â”€ SETUP BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.setup-banner{background:var(--amber-dim);border:1.5px solid rgba(245,166,35,.4);border-radius:var(--r);padding:16px 20px;margin-bottom:20px}
.setup-banner-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:800;color:#7a5000;margin-bottom:4px}
.setup-banner-body{font-size:12.5px;color:#8a6200;line-height:1.6}
.setup-banner-body code{font-family:'JetBrains Mono',monospace;font-size:11.5px;background:rgba(0,0,0,.06);padding:1px 5px;border-radius:4px}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-wrap{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--ink);color:#fff;padding:12px 18px;border-radius:10px;font-size:13px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.25);display:flex;align-items:center;gap:9px;min-width:240px;pointer-events:all;animation:toastIn .25s ease}
.toast.success{background:#0a7a50}.toast.error{background:var(--red)}.toast.info{background:var(--blue)}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.toast.hide{animation:toastOut .25s ease forwards}
@keyframes toastOut{to{opacity:0;transform:translateX(30px)}}

/* â”€â”€ FILTER ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fr{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:16px}

/* â”€â”€ SP SYNC INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sync-row{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--ink4);margin-bottom:14px}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--teal);flex-shrink:0}
.sync-dot.syncing{animation:pulse 1s ease infinite}
.sync-dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

@media(max-width:900px){.stats-grid{grid-template-columns:1fr 1fr}.fg2{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- â”€â”€ MSAL LOAD ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="msalLoadError" style="display:none;position:fixed;inset:0;background:#0c1220;z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:32px;text-align:center">
  <div style="font-size:40px">âš ï¸</div>
  <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:#fff">Microsoft Login Library Failed to Load</div>
  <div style="font-size:14px;color:rgba(255,255,255,.5);max-width:480px;line-height:1.7">Your browser could not load the Microsoft Authentication Library (MSAL) from the internet.<br/><br/>
  <strong style="color:rgba(255,255,255,.7)">To fix this:</strong><br/>
  1. Make sure you have an internet connection<br/>
  2. Check if a firewall or proxy is blocking <code style="font-family:'JetBrains Mono',monospace;font-size:12px;color:#00c39a">alcdn.msauth.net</code> or <code style="font-family:'JetBrains Mono',monospace;font-size:12px;color:#00c39a">cdn.jsdelivr.net</code><br/>
  3. Or use Demo Mode (no internet needed)</div>
  <button onclick="document.getElementById('msalLoadError').style.display='none';document.getElementById('loginScreen').style.display='flex';demoMode()" style="padding:12px 24px;background:#00c39a;color:#fff;border:none;border-radius:8px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer">Use Demo Mode Instead</button>
</div>

<!-- â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">ğŸ§ª</div>
    <div class="login-title">SampleTrack</div>
    <div class="login-sub">Free Sample Management System<br/>for your paint manufacturing team</div>

    <div class="login-config-note" id="configNote" style="display:none">
      <div class="cn-title">âš™ï¸ Setup Required</div>
      <div class="cn-body">IT admin: replace <code>YOUR_TENANT_ID</code> and <code>YOUR_CLIENT_ID</code> at the top of this file with your Azure AD app registration values.</div>
    </div>

    <div id="msalError" style="display:none;background:rgba(232,69,69,.15);border:1px solid rgba(232,69,69,.3);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#ff9999;text-align:left;font-family:'JetBrains Mono',monospace;word-break:break-all;line-height:1.6"></div>

    <button class="btn-ms" id="loginBtn" onclick="signIn()">
      <svg class="ms-logo" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
        <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
        <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
        <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
      </svg>
      Sign in with Microsoft 365
    </button>

    <hr class="login-divider"/>
    <div style="margin-bottom:12px">
      <button class="btn-ms" style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.1)" onclick="demoMode()">
        ğŸ§ª Try Demo Mode (no login)
      </button>
    </div>
    <div class="login-note">Only employees with a valid <strong style="color:rgba(255,255,255,.5)">@mrfpaint.com</strong> Microsoft account can access this app. Contact your IT admin if you have trouble signing in.</div>
  </div>
</div>

<!-- â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loadingScreen" style="display:none">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Signing you inâ€¦</div>
</div>

<!-- â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="appShell">
<div id="shell">
  <aside class="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-inner">
        <div class="sb-logo-icon">ğŸ§ª</div>
        <div><div class="sb-logo-text">SampleTrack</div><div class="sb-logo-sub">Free Sample Management</div></div>
      </div>
    </div>
    <div class="sb-user">
      <div class="sb-avatar" id="sbAvatar">?</div>
      <div style="overflow:hidden">
        <div class="sb-user-name" id="sbName">Loadingâ€¦</div>
        <div class="sb-user-role" id="sbRoleLabel">â€”</div>
      </div>
    </div>
    <nav class="sb-nav" id="sideNav"></nav>
    <div class="sb-footer">
      <span class="sb-footer-text">SampleTrack v2.0</span>
      <button class="btn-signout" onclick="signOut()">Sign Out</button>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbarTitle">Dashboard</div>
      <div class="topbar-right">
        <span class="sp-badge" id="spBadge">â¬¤ Demo Mode</span>
        <span class="role-pill" id="rolePill">Loading</span>
        <button class="btn btn-primary" id="topNewBtn" onclick="showPage('page-new-request')" style="display:none">+ New Request</button>
      </div>
    </div>
    <div class="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div id="setupBannerWrap"></div>
        <div class="stats-grid" id="statsGrid"></div>
        <div id="reminderBanner" style="display:none"></div>
        <div style="display:grid;grid-template-columns:1.4fr 1fr;gap:16px">
          <div class="card">
            <div class="card-head"><div class="card-title">Recent Requests</div></div>
            <div class="tw"><table><thead><tr><th>Ref #</th><th>Customer</th><th>Products</th><th>Status</th><th>Date</th></tr></thead><tbody id="dashRecent"></tbody></table></div>
          </div>
          <div class="card">
            <div class="card-head"><div class="card-title">Status Breakdown</div></div>
            <div style="padding:16px 20px" id="dashBreak"></div>
          </div>
        </div>
      </div>

      <!-- NEW REQUEST -->
      <div class="page" id="page-new-request">
        <div class="card">
          <div class="card-head"><div class="card-title">ğŸ“‹ New Sample Request</div><div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--ink4)">Ref# auto-generated</div></div>
          <div style="padding:24px" id="reqFormBody"></div>
        </div>
      </div>

      <!-- MY REQUESTS -->
      <div class="page" id="page-my-requests">
        <div class="fr">
          <input class="search-inp" placeholder="ğŸ” Searchâ€¦" id="mySearch" oninput="renderMyRequests()"/>
          <select class="fsel" id="myStatusF" onchange="renderMyRequests()">
            <option value="">All Status</option>
            <option value="Pending ASM">Pending ASM</option>
            <option value="ASM Approved">ASM Approved</option>
            <option value="Fully Approved">Fully Approved</option>
            <option value="SAP Linked">SAP Linked</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title" id="myReqTitle">My Requests</div><button class="btn btn-primary btn-sm" onclick="showPage('page-new-request')">+ New</button></div>
          <div class="tw"><table><thead><tr><th>Ref #</th><th>Customer</th><th>Site</th><th>Products</th><th>Dealer</th><th>Status</th><th>Date</th><th>SAP #</th><th>Actions</th></tr></thead><tbody id="myReqBody"></tbody></table></div>
        </div>
      </div>

      <!-- APPROVALS -->
      <div class="page" id="page-approvals">
        <div class="fr"><input class="search-inp" placeholder="ğŸ” Searchâ€¦" id="appSearch" oninput="renderApprovals()"/></div>
        <div class="card">
          <div class="card-head"><div class="card-title" id="appTitle">Pending Approvals</div></div>
          <div class="tw"><table><thead><tr><th>Ref #</th><th>Customer</th><th>Site Value</th><th>Products</th><th>Submitted By</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody id="appBody"></tbody></table></div>
        </div>
      </div>

      <!-- SAP TRACKER -->
      <div class="page" id="page-tracker">
        <div class="fr">
          <input class="search-inp" placeholder="ğŸ” Searchâ€¦" id="sapSearch" oninput="renderTracker()"/>
          <select class="fsel" id="sapF" onchange="renderTracker()">
            <option value="">All</option><option value="needs">Needs SAP #</option><option value="done">SAP Linked</option>
          </select>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">SAP Order Tracker</div></div>
          <div class="tw"><table><thead><tr><th>Ref #</th><th>Customer</th><th>Products</th><th>Approved On</th><th>SAP Order #</th><th>Updated By</th><th>Actions</th></tr></thead><tbody id="sapBody"></tbody></table></div>
        </div>
      </div>

      <!-- CONVERSION -->
      <div class="page" id="page-conversion">
        <div class="fr">
          <input class="search-inp" placeholder="ğŸ” Searchâ€¦" id="convSearch" oninput="renderConversion()"/>
          <select class="fsel" id="convF" onchange="renderConversion()">
            <option value="">All</option><option value="Converted">Converted</option><option value="Not Converted">Not Converted</option><option value="Pending">Pending</option>
          </select>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">Conversion Tracker</div></div>
          <div class="tw"><table><thead><tr><th>Ref #</th><th>Customer</th><th>Site Value</th><th>SAP Sample #</th><th>Outcome</th><th>Sales SAP Ref</th><th>Volume</th><th>Value</th><th>Actions</th></tr></thead><tbody id="convBody"></tbody></table></div>
        </div>
      </div>

      <!-- ADMIN PANEL -->
      <div class="page" id="page-admin">
        <div class="admin-notice">
          <div style="font-size:28px">ğŸ›¡ï¸</div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:2px">Admin Panel</div>
            <div style="font-size:12.5px;color:rgba(255,255,255,.6)">Assign roles to employees. Changes take effect on their next page load. In production, this data is stored in a SharePoint List.</div>
          </div>
        </div>
        <div class="fr">
          <input class="search-inp" placeholder="ğŸ” Search usersâ€¦" id="adminSearch" oninput="renderAdmin()"/>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title">User Role Management</div>
            <button class="btn btn-primary btn-sm" onclick="openAddUserModal()">+ Add User</button>
          </div>
          <div class="tw"><table><thead><tr><th>Name</th><th>Email</th><th>Department</th><th>Current Role</th><th>Last Login</th><th>Actions</th></tr></thead><tbody id="adminBody"></tbody></table></div>
        </div>

        <div class="card">
          <div class="card-head"><div class="card-title">SharePoint & Azure AD Configuration</div></div>
          <div style="padding:20px 24px">
            <div id="setupBannerInAdmin"></div>
            <div class="fg2" style="margin-bottom:16px">
              <div class="fg">
                <label class="fl">Azure AD Tenant ID</label>
                <input type="text" id="cfg_tenant" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" style="font-family:'JetBrains Mono',monospace;font-size:12px"/>
              </div>
              <div class="fg">
                <label class="fl">Azure AD Client ID (App Registration)</label>
                <input type="text" id="cfg_client" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" style="font-family:'JetBrains Mono',monospace;font-size:12px"/>
              </div>
            </div>
            <div class="fg2" style="margin-bottom:16px">
              <div class="fg">
                <label class="fl">SharePoint Site URL</label>
                <input type="text" id="cfg_sp" placeholder="https://mrfvapocurepaint.sharepoint.com/sites/SampleTrack"/>
              </div>
              <div class="fg">
                <label class="fl">SharePoint List Name (for requests)</label>
                <input type="text" id="cfg_list" placeholder="SampleRequests"/>
              </div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ Save Configuration</button>
              <button class="btn btn-ghost" onclick="testSPConnection()">ğŸ”Œ Test SharePoint Connection</button>
              <span id="connStatus" style="font-size:12px;color:var(--ink4)"></span>
            </div>
            <div style="margin-top:20px;background:var(--surface);border-radius:10px;padding:16px 20px">
              <div style="font-family:'Syne',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--ink3);margin-bottom:12px">ğŸ“‹ IT Admin Setup Checklist</div>
              <div id="setupChecklist"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<!-- REJECT MODAL -->
<div class="mo" id="moReject">
  <div class="md">
    <div class="md-head"><div class="md-title">Reject Request</div><button class="md-close" onclick="closeMo('moReject')">âœ•</button></div>
    <div class="md-body">
      <p style="color:var(--ink3);margin-bottom:14px;font-size:13px">Provide a reason â€” it will be visible to the submitter and triggers an email notification.</p>
      <div class="fg"><label class="fl">Rejection Reason <span class="req">*</span></label><textarea id="rejectReason" rows="4" placeholder="Explain why this is being rejectedâ€¦"></textarea></div>
    </div>
    <div class="md-foot"><button class="btn btn-ghost" onclick="closeMo('moReject')">Cancel</button><button class="btn btn-rej" onclick="confirmReject()">Confirm Rejection</button></div>
  </div>
</div>

<!-- SAP MODAL -->
<div class="mo" id="moSAP">
  <div class="md">
    <div class="md-head"><div class="md-title">Update SAP Order Number</div><button class="md-close" onclick="closeMo('moSAP')">âœ•</button></div>
    <div class="md-body">
      <p style="color:var(--ink3);margin-bottom:14px;font-size:13px">Create the SAP order and enter the SAP Order Number to complete the request cycle.</p>
      <div class="fg"><label class="fl">SAP Order Number <span class="req">*</span></label><input type="text" id="sapInput" placeholder="e.g. 5000123456" style="font-family:'JetBrains Mono',monospace"/></div>
    </div>
    <div class="md-foot"><button class="btn btn-ghost" onclick="closeMo('moSAP')">Cancel</button><button class="btn btn-primary" onclick="confirmSAP()">Save SAP Number</button></div>
  </div>
</div>

<!-- CONVERSION MODAL -->
<div class="mo" id="moConv">
  <div class="md">
    <div class="md-head"><div class="md-title">Update Conversion Status</div><button class="md-close" onclick="closeMo('moConv')">âœ•</button></div>
    <div class="md-body">
      <div class="fg" style="margin-bottom:14px">
        <label class="fl">Outcome</label>
        <select id="convOutcome" onchange="toggleConvF()">
          <option value="Pending">Pending â€“ Not yet determined</option>
          <option value="Converted">âœ… Converted to Sales Order</option>
          <option value="Not Converted">âŒ Not Converted</option>
        </select>
      </div>
      <div id="convFields" style="display:none">
        <div class="fg2" style="margin-bottom:12px">
          <div class="fg"><label class="fl">Sales Order Volume (units)</label><input type="number" id="convVol" placeholder="e.g. 500"/></div>
          <div class="fg"><label class="fl">Sales Order Value (â‚¹)</label><input type="number" id="convVal" placeholder="e.g. 250000"/></div>
        </div>
        <div class="fg"><label class="fl">Sales Order SAP Ref #</label><input type="text" id="convSAPRef" placeholder="e.g. 4900098712" style="font-family:'JetBrains Mono',monospace"/></div>
      </div>
    </div>
    <div class="md-foot"><button class="btn btn-ghost" onclick="closeMo('moConv')">Cancel</button><button class="btn btn-primary" onclick="confirmConv()">Save Status</button></div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="mo" id="moDetail">
  <div class="md md-lg">
    <div class="md-head"><div class="md-title" id="moDetailTitle">Request Details</div><button class="md-close" onclick="closeMo('moDetail')">âœ•</button></div>
    <div class="md-body" id="moDetailBody"></div>
    <div class="md-foot" id="moDetailFoot"></div>
  </div>
</div>

<!-- ADD USER MODAL -->
<div class="mo" id="moAddUser">
  <div class="md">
    <div class="md-head"><div class="md-title">Add / Update User Role</div><button class="md-close" onclick="closeMo('moAddUser')">âœ•</button></div>
    <div class="md-body">
      <p style="color:var(--ink3);margin-bottom:16px;font-size:13px">Enter the employee's Microsoft 365 email address and assign their role. They must exist in your Azure AD tenant.</p>
      <div class="fg2">
        <div class="fg"><label class="fl">Display Name <span class="req">*</span></label><input type="text" id="au_name" placeholder="e.g. Priya Sharma"/></div>
        <div class="fg"><label class="fl">M365 Email <span class="req">*</span></label><input type="text" id="au_email" placeholder="priya@mrfpaint.com"/></div>
        <div class="fg"><label class="fl">Department</label><input type="text" id="au_dept" placeholder="e.g. Sales â€“ South Zone"/></div>
        <div class="fg"><label class="fl">Role <span class="req">*</span></label>
          <select id="au_role">
            <option value="sales">Sales Employee</option>
            <option value="asm">Area Sales Manager (ASM)</option>
            <option value="rsm">Regional Sales Manager (RSM)</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
    </div>
    <div class="md-foot"><button class="btn btn-ghost" onclick="closeMo('moAddUser')">Cancel</button><button class="btn btn-primary" onclick="confirmAddUser()">Save User</button></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  CONFIGURATION  â”€â”€ IT Admin: fill these in
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  tenantId:    '2d3a57cf-4548-4088-a4b4-3f336f531b04',  // MRF Corp Limited
  clientId:    '2dcdecf0-0780-4700-8237-01b0a639eb0f',  // FreeSampleTracker
  spSiteUrl:   'https://mrfvapocurepaint.sharepoint.com/sites/SampleTrack',
  spListName:  'SampleRequests',
  // Redirect URI must match what's registered in Azure AD
  // For SharePoint: https://mrfpaint.sharepoint.com/sites/intranet/SitePages/SampleTrack.aspx
};

const IS_CONFIGURED = CONFIG.tenantId !== 'YOUR_TENANT_ID' && CONFIG.clientId !== 'YOUR_CLIENT_ID';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  MSAL SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let msalInstance = null;
let currentUser = null;  // { name, email, role, initials }
let isDemoMode = false;
let isLiveMode = false;  // true when connected to SharePoint

const SCOPES = ['User.Read', 'Sites.ReadWrite.All', 'Mail.Send'];

let msalReady = false;

async function initMSAL() {
  if (!IS_CONFIGURED) {
    document.getElementById('configNote').style.display = 'block';
    return;
  }

  // Detect local file â€” MSAL redirect flow does not work from file://
  const isLocalFile = window.location.protocol === 'file:';
  // Use current page URL as redirect URI (works on SharePoint)
  const redirectUri = isLocalFile 
    ? 'http://localhost' 
    : window.location.href.split('#')[0].split('?')[0];

  console.log('[MSAL] Starting init...');
  console.log('[MSAL] Protocol:', window.location.protocol);
  console.log('[MSAL] Redirect URI:', redirectUri);
  console.log('[MSAL] Client ID:', CONFIG.clientId);
  console.log('[MSAL] Tenant ID:', CONFIG.tenantId);

  try {
    msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: CONFIG.clientId,
        authority: `https://login.microsoftonline.com/${CONFIG.tenantId}`,
        redirectUri: redirectUri,
        navigateToLoginRequestUrl: false,
      },
      cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true },
      system: {
        loggerOptions: {
          loggerCallback: (level, message) => console.log('[MSAL]', message),
          logLevel: msal.LogLevel.Warning,
        }
      }
    });

    console.log('[MSAL] Instance created, calling initialize()...');
    await msalInstance.initialize();
    console.log('[MSAL] initialize() done. msalReady = true');
    msalReady = true;

    if (!isLocalFile) {
      const resp = await msalInstance.handleRedirectPromise();
      if (resp) { await handleAuthResponse(resp); return; }
    }

    const accounts = msalInstance.getAllAccounts();
    console.log('[MSAL] Existing accounts:', accounts.length);
    if (accounts.length > 0) await resumeSession(accounts[0]);

  } catch(e) {
    console.error('[MSAL] Init error:', e);
    // Show the real error so we can debug
    document.getElementById('msalError').textContent = 'Error: ' + e.message;
    document.getElementById('msalError').style.display = 'block';
  }
}

async function signIn() {
  if (!IS_CONFIGURED) { toast('Azure AD not configured. Use Demo Mode.', 'error'); return; }
  if (!msalReady || !msalInstance) {
    toast('Microsoft login not ready. Check browser console (F12) for details.', 'error');
    return;
  }
  document.getElementById('loginBtn').disabled = true;
  const isLocalFile = window.location.protocol === 'file:';
  try {
    if (isLocalFile) {
      // Popup works for local file testing; redirect needs a real URL
      const resp = await msalInstance.loginPopup({ scopes: SCOPES });
      await handleAuthResponse(resp);
    } else {
      await msalInstance.loginRedirect({ scopes: SCOPES });
    }
  } catch(e) {
    console.error('[MSAL] Sign in error:', e);
    document.getElementById('loginBtn').disabled = false;
    toast('Sign in failed: ' + e.message, 'error');
  }
}

async function handleAuthResponse(response) {
  showLoading('Signing you inâ€¦');
  const account = response.account;
  await loadUserAndLaunch(account);
}

async function resumeSession(account) {
  showLoading('Resuming sessionâ€¦');
  await loadUserAndLaunch(account);
}

async function loadUserAndLaunch(account) {
  try {
    showLoading('Loading your profileâ€¦');
    const tokenResp = await msalInstance.acquireTokenSilent({ scopes: SCOPES, account });
    const profile = await callGraph('https://graph.microsoft.com/v1.0/me', tokenResp.accessToken);
    const name = profile.displayName || account.name;
    const email = profile.mail || profile.userPrincipalName;
    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    isLiveMode = true;
    // Load all data from SharePoint
    await spLoadAll();
    // Look up role from SharePoint AppUsers list
    const userRecord = _users.find(u => u.email.toLowerCase() === email.toLowerCase());
    const role = userRecord?.role || 'sales';
    currentUser = { name, email, initials, role, dept: userRecord?.dept || profile.department || '', spId: userRecord?.spId };
    // Update last login in SharePoint
    if (userRecord) {
      userRecord.lastLogin = new Date().toISOString();
      spSaveUser(userRecord).catch(console.error);
    }
    launchApp();
  } catch(e) {
    console.error('[Auth] loadUserAndLaunch error:', e);
    toast('SharePoint connection failed â€” running in local mode.', 'info');
    isLiveMode = false;
    demoMode();
  }
}

async function callGraph(url, token) {
  const r = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
  return r.json();
}

function signOut() {
  if (msalInstance && !isDemoMode) {
    msalInstance.logoutRedirect();
  } else {
    currentUser = null; isDemoMode = false;
    document.getElementById('appShell').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
  }
}

// Demo mode â€” no M365 login
function demoMode() {
  isDemoMode = true; isLiveMode = false;
  currentUser = { name: 'Demo User', email: 'demo@mrfpaint.com', initials: 'DU', role: 'admin', dept: 'Demo' };
  // Seed demo data into localStorage if empty
  const existing = localStorage.getItem('fsms_demo');
  if (!existing || JSON.parse(existing).requests.length === 0) {
    seed();
    seedUsers();
  }
  launchApp();
}

function showLoading(msg) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';
  document.getElementById('loadingText').textContent = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  DATA LAYER  â”€â”€ SharePoint via Microsoft Graph
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CK = 'fsms_cfg_v1';
const SP_SITE = 'https://mrfvapocurepaint.sharepoint.com/sites/SampleTrack';
const SP_API  = `${SP_SITE}/_api/web/lists/getbytitle`;

// In-memory cache â€” populated on login, kept in sync on writes
let _requests = [];
let _users    = [];
let _spToken  = null;   // SharePoint token
let _mailToken = null;  // Mail token

// â”€â”€ Token helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getToken(scopes) {
  if (!msalInstance) return null;
  try {
    const accounts = msalInstance.getAllAccounts();
    const resp = await msalInstance.acquireTokenSilent({ scopes, account: accounts[0] });
    return resp.accessToken;
  } catch(e) {
    console.error('Token error:', e);
    return null;
  }
}

async function refreshTokens() {
  _spToken   = await getToken(['https://mrfvapocurepaint.sharepoint.com/.default']);
  _mailToken = await getToken(['Mail.Send']);
}

// â”€â”€ SharePoint REST helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spHeaders(token, extra={}) {
  return {
    Authorization: `Bearer ${token}`,
    Accept: 'application/json;odata=nometadata',
    'Content-Type': 'application/json',
    ...extra
  };
}

async function spGet(listName, token, filter='') {
  const url = `${SP_API}('${listName}')/items?$top=5000${filter?'&$filter='+filter:''}`;
  const r = await fetch(url, { headers: spHeaders(token) });
  if (!r.ok) throw new Error(`SP GET ${listName} failed: ${r.status}`);
  const d = await r.json();
  return d.value;
}

async function spPost(listName, token, body) {
  const url = `${SP_API}('${listName}')/items`;
  console.log('[SP POST] List:', listName);
  console.log('[SP POST] Body:', JSON.stringify(body, null, 2));
  // Validate: check for any non-string values in string fields
  Object.entries(body).forEach(([k,v]) => {
    if (v !== null && typeof v !== 'string' && typeof v !== 'number' && typeof v !== 'boolean') {
      console.warn(`[SP POST] Field "${k}" has unexpected type: ${typeof v} =`, v);
    }
  });
  const digest = await getDigest(token);
  const r = await fetch(url, { method:'POST', headers: spHeaders(token, {"X-RequestDigest": digest}), body: JSON.stringify(body) });
  if (!r.ok) {
    const errText = await r.text();
    console.error('[SP POST] Error response:', errText);
    console.error('[SP POST] Failed body was:', JSON.stringify(body, null, 2));
    throw new Error(`SP POST ${listName} failed: ${r.status} ${errText}`);
  }
  return r.json();
}

async function spPatch(listName, token, itemId, body) {
  const url = `${SP_API}('${listName}')/items(${itemId})`;
  const r = await fetch(url, {
    method: 'POST',
    headers: spHeaders(token, {
      'X-HTTP-Method': 'MERGE',
      'IF-MATCH': '*',
      "X-RequestDigest": await getDigest(token)
    }),
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(`SP PATCH ${listName}(${itemId}) failed: ${r.status}`);
}

async function getDigest(token) {
  const r = await fetch(`${SP_SITE}/_api/contextinfo`, {
    method: 'POST',
    headers: { Authorization:`Bearer ${token}`, Accept:'application/json;odata=nometadata' }
  });
  const d = await r.json();
  return d.FormDigestValue;
}

// â”€â”€ Request mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spToRequest(item) {
  return {
    id: String(item.Id),
    spId: item.Id,
    refNo: item.RefNo||'',
    custName: item.CustName||'',
    custContact: item.CustContact||'',
    acctType: item.AcctType||'',
    acctClass: item.AcctClass||'',
    siteName: item.SiteName||'',
    siteAddr: item.SiteAddr||'',
    siteVal: item.SiteVal||'',
    siteVol: item.SiteVol||'',
    prods: (() => { try { return JSON.parse(item.Products||'[]'); } catch { return []; } })(),
    inflName: item.InflName||'',
    inflRole: item.InflRole||'',
    dealerName: item.DealerName||'',
    dealerLoc: item.DealerLoc||'',
    notes: item.Notes||'',
    status: item.Status||'Pending ASM',
    submittedBy: item.SubmittedBy||'',
    submittedByEmail: item.SubmittedByEmail||'',
    submittedAt: item.SubmittedAt||new Date().toISOString(),
    asmAt: item.AsmAt||null,
    asmBy: item.AsmBy||null,
    rsmAt: item.RsmAt||null,
    rsmBy: item.RsmBy||null,
    rejReason: item.RejReason||null,
    sapNo: item.SapNo||null,
    sapAt: item.SapAt||null,
    sapBy: item.SapBy||null,
    conv: item.Conv||'Pending',
    convAt: item.ConvAt||null,
    convVol: item.ConvVol||null,
    convVal: item.ConvVal||null,
    convRef: item.ConvRef||null,
  };
}

function requestToSp(req) {
  // Helper: safe string â€” never send null/undefined to text columns
  const s = v => (v === null || v === undefined) ? '' : String(v);
  // Helper: safe number â€” send null for empty number columns (SharePoint accepts null for Number)
  const n = v => (v === null || v === undefined || v === '') ? null : Number(v);
  return {
    RefNo: s(req.refNo),
    CustName: s(req.custName),
    CustContact: s(req.custContact),
    AcctType: s(req.acctType),
    AcctClass: s(req.acctClass),
    SiteName: s(req.siteName),
    SiteAddr: s(req.siteAddr),
    SiteVal: n(req.siteVal),
    SiteVol: n(req.siteVol),
    Products: JSON.stringify(req.prods||[]),
    InflName: s(req.inflName),
    InflRole: s(req.inflRole),
    DealerName: s(req.dealerName),
    DealerLoc: s(req.dealerLoc),
    Notes: s(req.notes),
    Status: s(req.status),
    SubmittedBy: s(req.submittedBy),
    SubmittedByEmail: s(req.submittedByEmail),
    SubmittedAt: s(req.submittedAt),
    AsmAt: s(req.asmAt),
    AsmBy: s(req.asmBy),
    RsmAt: s(req.rsmAt),
    RsmBy: s(req.rsmBy),
    RejReason: s(req.rejReason),
    SapNo: s(req.sapNo),
    SapAt: s(req.sapAt),
    SapBy: s(req.sapBy),
    Conv: s(req.conv) || 'Pending',
    ConvAt: s(req.convAt),
    ConvVol: n(req.convVol),
    ConvVal: n(req.convVal),
    ConvRef: s(req.convRef),
  };
}

// â”€â”€ User mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spToUser(item) {
  return {
    id: String(item.Id),
    spId: item.Id,
    name: item.UserName||'',
    email: item.Email||'',
    dept: item.Department||'',
    role: item.Role||'sales',
    lastLogin: item.LastLogin||null,
  };
}

function userToSp(u) {
  const s = v => (v === null || v === undefined) ? '' : String(v);
  return {
    UserName: s(u.name),
    Email: s(u.email),
    Department: s(u.dept),
    Role: s(u.role),
    LastLogin: s(u.lastLogin),
  };
}

// â”€â”€ Main data operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Load all data from SharePoint into memory cache
async function spLoadAll() {
  showLoading('Loading data from SharePointâ€¦');
  try {
    await refreshTokens();
    const [reqItems, userItems] = await Promise.all([
      spGet('SampleRequests', _spToken),
      spGet('AppUsers', _spToken),
    ]);
    _requests = reqItems.map(spToRequest);
    _users    = userItems.map(spToUser);
    // Generate next counter from existing refs
    console.log(`[SP] Loaded ${_requests.length} requests, ${_users.length} users`);
  } catch(e) {
    console.error('[SP] Load failed:', e);
    toast('SharePoint load failed. Check console.', 'error');
    _requests = [];
    _users = [];
  }
}

// â”€â”€ Local read (from cache) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function load() {
  if (isDemoMode) {
    try { return JSON.parse(localStorage.getItem('fsms_demo'))||{requests:[],ctr:1}; } catch { return {requests:[],ctr:1}; }
  }
  // Build a counter from existing refNos
  const maxCtr = _requests.reduce((max, r) => {
    const parts = (r.refNo||'').split('-');
    const n = parseInt(parts[parts.length-1])||0;
    return Math.max(max, n);
  }, 0);
  return { requests: _requests, ctr: maxCtr + 1 };
}

function getUsers() {
  if (isDemoMode) {
    try { return JSON.parse(localStorage.getItem('fsms_demo_users'))||getDemoUsers(); } catch { return getDemoUsers(); }
  }
  return _users.length ? _users : getDemoUsers();
}

// â”€â”€ Writes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Create new request in SharePoint
async function spCreateRequest(req) {
  if (isDemoMode) {
    const d = load(); d.requests.push(req); d.ctr++;
    localStorage.setItem('fsms_demo', JSON.stringify(d)); return;
  }
  try {
    showSyncIndicator(true);
    const created = await spPost('SampleRequests', _spToken, requestToSp(req));
    req.spId = created.Id;
    req.id = String(created.Id);
    _requests.push(req);
    showSyncIndicator(false);
  } catch(e) {
    showSyncIndicator(false, true);
    console.error('[SP] Create request failed:', e);
    toast('Failed to save to SharePoint: ' + e.message, 'error');
    throw e;
  }
}

// Update existing request in SharePoint
async function spUpdateRequest(req) {
  if (isDemoMode) {
    const d = load();
    const idx = d.requests.findIndex(x=>x.id===req.id);
    if (idx>=0) d.requests[idx]=req;
    localStorage.setItem('fsms_demo', JSON.stringify(d)); return;
  }
  try {
    showSyncIndicator(true);
    await spPatch('SampleRequests', _spToken, req.spId, requestToSp(req));
    const idx = _requests.findIndex(x=>x.id===req.id);
    if (idx>=0) _requests[idx]=req;
    showSyncIndicator(false);
  } catch(e) {
    showSyncIndicator(false, true);
    console.error('[SP] Update request failed:', e);
    toast('Failed to update SharePoint: ' + e.message, 'error');
    throw e;
  }
}

// Create or update user in SharePoint
async function spSaveUser(user) {
  if (isDemoMode) {
    const users = getUsers();
    const idx = users.findIndex(u=>u.email.toLowerCase()===user.email.toLowerCase());
    if (idx>=0) users[idx]=user; else users.push(user);
    localStorage.setItem('fsms_demo_users', JSON.stringify(users)); return;
  }
  try {
    showSyncIndicator(true);
    if (user.spId) {
      await spPatch('AppUsers', _spToken, user.spId, userToSp(user));
      const idx = _users.findIndex(u=>u.email.toLowerCase()===user.email.toLowerCase());
      if (idx>=0) _users[idx]=user;
    } else {
      const created = await spPost('AppUsers', _spToken, userToSp(user));
      user.spId = created.Id;
      user.id = String(created.Id);
      const idx = _users.findIndex(u=>u.email.toLowerCase()===user.email.toLowerCase());
      if (idx>=0) _users[idx]=user; else _users.push(user);
    }
    showSyncIndicator(false);
  } catch(e) {
    showSyncIndicator(false, true);
    console.error('[SP] Save user failed:', e);
    toast('Failed to save user: ' + e.message, 'error');
    throw e;
  }
}

async function spDeleteUser(email) {
  if (isDemoMode) {
    const users = getUsers().filter(u=>u.email.toLowerCase()!==email.toLowerCase());
    localStorage.setItem('fsms_demo_users', JSON.stringify(users)); return;
  }
  const user = _users.find(u=>u.email.toLowerCase()===email.toLowerCase());
  if (!user?.spId) return;
  try {
    await fetch(`${SP_API}('AppUsers')/items(${user.spId})`, {
      method: 'POST',
      headers: spHeaders(_spToken, { 'X-HTTP-Method':'DELETE', 'IF-MATCH':'*', 'X-RequestDigest': await getDigest(_spToken) })
    });
    _users = _users.filter(u=>u.email.toLowerCase()!==email.toLowerCase());
  } catch(e) { console.error('[SP] Delete user failed:', e); }
}

// â”€â”€ Sync indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSyncIndicator(syncing, error=false) {
  const spb = document.getElementById('spBadge');
  if (!spb) return;
  if (syncing) { spb.textContent = 'â¬¤ Savingâ€¦'; spb.className = 'sp-badge local'; }
  else if (error) { spb.textContent = 'â¬¤ Sync Error'; spb.className = 'sp-badge local'; }
  else { spb.textContent = 'â¬¤ SharePoint Live'; spb.className = 'sp-badge live'; }
}

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCfg() { try { return JSON.parse(localStorage.getItem(CK))||{}; } catch { return {}; } }
function saveCfg(c) { localStorage.setItem(CK, JSON.stringify(c)); }

// â”€â”€ Demo fallback users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDemoUsers() {
  return [
    { name:'Demo User', email:'demo@mrfpaint.com', dept:'Demo', role:'admin', lastLogin: new Date().toISOString() },
  ];
}

async function sendNotification(toEmail, subject, bodyHtml) {
  if (!isLiveMode || !msalInstance) {
    console.log(`[Demo] Email to ${toEmail}: ${subject}`);
    return;
  }
  try {
    const accounts = msalInstance.getAllAccounts();
    const token = await msalInstance.acquireTokenSilent({ scopes: ['Mail.Send'], account: accounts[0] });
    await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
      method: 'POST',
      headers: { Authorization: `Bearer ${token.accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: { subject, body: { contentType: 'HTML', content: bodyHtml }, toRecipients: [{ emailAddress: { address: toEmail } }] },
        saveToSentItems: true
      })
    });
  } catch(e) { console.error('Email failed:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  APP LAUNCH & NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curPage = 'page-dashboard';
let rejectId = null, sapId = null, convId = null, prc = 0;

function launchApp() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';

  // Update sidebar user info
  document.getElementById('sbAvatar').textContent = currentUser.initials;
  document.getElementById('sbName').textContent = currentUser.name;
  document.getElementById('sbRoleLabel').textContent = roleLabel(currentUser.role);

  // Update role pill
  const rp = document.getElementById('rolePill');
  rp.textContent = roleLabel(currentUser.role);
  rp.className = 'role-pill ' + currentUser.role;

  // Storage mode badge
  const spb = document.getElementById('spBadge');
  if (isLiveMode) { spb.textContent = 'â¬¤ SharePoint Live'; spb.className = 'sp-badge live'; }
  else if (isDemoMode) { spb.textContent = 'â¬¤ Demo Mode'; spb.className = 'sp-badge local'; }
  else { spb.textContent = 'â¬¤ Local Storage'; spb.className = 'sp-badge local'; }

  // Show new request button for sales
  document.getElementById('topNewBtn').style.display = currentUser.role === 'sales' ? '' : 'none';

  // Last login recorded in SharePoint during loadUserAndLaunch

  renderNav();
  showPage('page-dashboard');
}

const NAVS = {
  sales:[
    {s:'Overview', items:[{id:'page-dashboard',ic:'ğŸ“Š',lb:'Dashboard'}]},
    {s:'Requests', items:[{id:'page-new-request',ic:'â•',lb:'New Request'},{id:'page-my-requests',ic:'ğŸ“‹',lb:'My Requests',bk:'myPend'}]},
    {s:'Tracking', items:[{id:'page-tracker',ic:'ğŸ”—',lb:'SAP Tracker',bk:'sapNeed'},{id:'page-conversion',ic:'ğŸ“ˆ',lb:'Conversion',bk:'convPend'}]},
  ],
  asm:[
    {s:'Overview', items:[{id:'page-dashboard',ic:'ğŸ“Š',lb:'Dashboard'}]},
    {s:'Approvals', items:[{id:'page-approvals',ic:'âœ…',lb:'Pending Approvals',bk:'asmPend'}]},
    {s:'Tracking', items:[{id:'page-my-requests',ic:'ğŸ“‹',lb:'All Requests'},{id:'page-conversion',ic:'ğŸ“ˆ',lb:'Conversion'}]},
  ],
  rsm:[
    {s:'Overview', items:[{id:'page-dashboard',ic:'ğŸ“Š',lb:'Dashboard'}]},
    {s:'Approvals', items:[{id:'page-approvals',ic:'âœ…',lb:'Pending Approvals',bk:'rsmPend'}]},
    {s:'Tracking', items:[{id:'page-my-requests',ic:'ğŸ“‹',lb:'All Requests'},{id:'page-conversion',ic:'ğŸ“ˆ',lb:'Conversion'}]},
  ],
  admin:[
    {s:'Overview', items:[{id:'page-dashboard',ic:'ğŸ“Š',lb:'Dashboard'}]},
    {s:'Management', items:[{id:'page-admin',ic:'ğŸ›¡ï¸',lb:'Admin Panel',bk:'unassigned'},{id:'page-my-requests',ic:'ğŸ“‹',lb:'All Requests'}]},
    {s:'Tracking', items:[{id:'page-tracker',ic:'ğŸ”—',lb:'SAP Tracker'},{id:'page-conversion',ic:'ğŸ“ˆ',lb:'Conversion'}]},
  ],
};

function badges() {
  const r = load().requests || [];
  const users = getUsers();
  return {
    myPend: r.filter(x=>x.status==='Rejected').length,
    sapNeed: r.filter(x=>x.status==='Fully Approved'&&!x.sapNo).length,
    convPend: r.filter(x=>x.sapNo&&x.conv==='Pending').length,
    asmPend: r.filter(x=>x.status==='Pending ASM').length,
    rsmPend: r.filter(x=>x.status==='ASM Approved').length,
    unassigned: users.filter(x=>!x.role||x.role==='sales').length,
  };
}

function renderNav() {
  const role = currentUser?.role || 'sales';
  const b = badges();
  const sections = NAVS[role] || NAVS.sales;
  document.getElementById('sideNav').innerHTML = sections.map(sec=>`
    <div class="sb-nav-section">
      <div class="sb-nav-label">${sec.s}</div>
      ${sec.items.map(it=>{
        const c = it.bk ? b[it.bk]||0 : 0;
        return `<button class="nav-btn${curPage===it.id?' active':''}" onclick="showPage('${it.id}')">
          <span class="nic">${it.ic}</span>${it.lb}
          ${c>0?`<span class="nb">${c}</span>`:''}
        </button>`;
      }).join('')}
    </div>`).join('');
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
  curPage = id;
  renderNav();
  const titles = {'page-dashboard':'Dashboard','page-new-request':'New Sample Request','page-my-requests':currentUser?.role==='sales'?'My Requests':'All Requests','page-approvals':'Pending Approvals','page-tracker':'SAP Order Tracker','page-conversion':'Conversion Tracker','page-admin':'Admin Panel'};
  document.getElementById('topbarTitle').textContent = titles[id] || id;
  if(id==='page-dashboard') renderDash();
  if(id==='page-new-request') renderForm();
  if(id==='page-my-requests') renderMyRequests();
  if(id==='page-approvals') renderApprovals();
  if(id==='page-tracker') renderTracker();
  if(id==='page-conversion') renderConversion();
  if(id==='page-admin') renderAdmin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const d = load(), r = d.requests||[];
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat c-teal"><div class="stat-label">Total Requests</div><div class="stat-val">${r.length}</div><div class="stat-sub">All time</div></div>
    <div class="stat c-amber"><div class="stat-label">Pending Approval</div><div class="stat-val">${r.filter(x=>['Pending ASM','ASM Approved'].includes(x.status)).length}</div><div class="stat-sub">Awaiting review</div></div>
    <div class="stat c-blue"><div class="stat-label">SAP Linked</div><div class="stat-val">${r.filter(x=>x.sapNo).length}</div><div class="stat-sub">Orders created</div></div>
    <div class="stat c-violet"><div class="stat-label">Converted</div><div class="stat-val">${r.filter(x=>x.conv==='Converted').length}</div><div class="stat-sub">Became sales orders</div></div>`;

  // Setup banner
  const sw = document.getElementById('setupBannerWrap');
  if (!IS_CONFIGURED) {
    sw.innerHTML=`<div class="setup-banner">
      <div class="setup-banner-title">âš™ï¸ Azure AD & SharePoint Not Configured</div>
      <div class="setup-banner-body">The app is running in local demo mode. Go to <strong>Admin Panel â†’ Configuration</strong> to enter your <code>Tenant ID</code>, <code>Client ID</code>, and <code>SharePoint Site URL</code>. Once set, employees will log in with their Microsoft 365 accounts and all data will be stored in SharePoint.</div>
    </div>`;
  } else { sw.innerHTML = ''; }

  const sapNeed = r.filter(x=>x.status==='Fully Approved'&&!x.sapNo);
  const cpend = r.filter(x=>x.sapNo&&x.conv==='Pending');
  const rb = document.getElementById('reminderBanner');
  if (sapNeed.length>0) {
    rb.style.display='flex'; rb.className='rbanner';
    rb.innerHTML=`<div class="rbi">â°</div><div class="rbt"><div class="rbt-title">${sapNeed.length} request(s) approved â€” SAP order not created yet</div><div class="rbt-sub">Update SAP Order Number to complete the cycle. Reminder emails sent to assigned sales reps.</div></div><button class="btn btn-ghost" onclick="showPage('page-tracker')" style="background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2)">Go to Tracker â†’</button>`;
  } else if (cpend.length>0) {
    rb.style.display='flex'; rb.className='rbanner';
    rb.innerHTML=`<div class="rbi">ğŸ“¬</div><div class="rbt"><div class="rbt-title">${cpend.length} sample(s) pending conversion update</div><div class="rbt-sub">Please update whether samples converted to actual sales orders.</div></div><button class="btn btn-ghost" onclick="showPage('page-conversion')" style="background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2)">Update Now â†’</button>`;
  } else { rb.style.display='none'; }

  const recent = [...r].sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt)).slice(0,6);
  document.getElementById('dashRecent').innerHTML = !recent.length
    ? `<tr><td colspan="5"><div class="es"><div class="es-icon">ğŸ“­</div>No requests yet</div></td></tr>`
    : recent.map(x=>`<tr>
        <td class="mono" style="cursor:pointer;color:var(--teal)" onclick="openDetail('${x.id}')">${x.refNo}</td>
        <td>${esc(x.custName)}</td>
        <td style="max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc((x.prods||[]).map(p=>p.name).join(', '))}</td>
        <td>${sbadge(x.status)}</td>
        <td style="color:var(--ink4);font-size:12px">${fd(x.submittedAt)}</td>
      </tr>`).join('');

  const sc={};r.forEach(x=>{sc[x.status]=(sc[x.status]||0)+1});
  const cols={'Pending ASM':'var(--amber)','ASM Approved':'var(--blue)','Fully Approved':'var(--teal)','SAP Linked':'#1a56db','Rejected':'var(--red)'};
  document.getElementById('dashBreak').innerHTML = Object.entries(sc).map(([k,v])=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--surface2)">
      <div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:${cols[k]||'var(--ink4)'}"></div><span style="font-size:13px;color:var(--ink2)">${k}</span></div>
      <span style="font-family:'Syne',sans-serif;font-weight:700;color:var(--ink)">${v}</span>
    </div>`).join('') || '<div class="es">No data yet</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  REQUEST FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderForm() {
  prc=0;
  document.getElementById('reqFormBody').innerHTML=`
    <div class="fs"><div class="fs-title">ğŸ‘¤ Customer Details</div>
      <div class="fg2">
        <div class="fg"><label class="fl">Customer Name <span class="req">*</span></label><input type="text" id="f_cn" placeholder="e.g. ABC Industries Pvt Ltd"/></div>
        <div class="fg"><label class="fl">Contact Person / Phone</label><input type="text" id="f_cc" placeholder="Name Â· Phone / Email"/></div>
        <div class="fg"><label class="fl">Account Type</label><select id="f_at"><option>Direct</option><option>Distributor</option><option>Institutional</option><option>Retail</option><option>Other</option></select></div>
        <div class="fg"><label class="fl">Account Classification</label><select id="f_ac"><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
      </div>
    </div>
    <div class="fs"><div class="fs-title">ğŸ­ Site Details</div>
      <div class="fg2">
        <div class="fg"><label class="fl">Site Name <span class="req">*</span></label><input type="text" id="f_sn" placeholder="Site / facility name"/></div>
        <div class="fg"><label class="fl">Site Address</label><input type="text" id="f_sa" placeholder="City, State"/></div>
        <div class="fg"><label class="fl">Potential Value (â‚¹)</label><input type="number" id="f_sv" placeholder="e.g. 500000"/></div>
        <div class="fg"><label class="fl">Est. Volume (units/month)</label><input type="number" id="f_svol" placeholder="e.g. 200"/></div>
      </div>
    </div>
    <div class="fs"><div class="fs-title">ğŸ“¦ Product Details</div>
      <div id="prodRows"></div>
      <button class="add-row" onclick="addProdRow()">+ Add Product</button>
    </div>
    <div class="fs"><div class="fs-title">ğŸŒŸ Influencer Details <span style="color:var(--ink4);font-size:11px;font-weight:400;text-transform:none">(optional)</span></div>
      <div class="fg2">
        <div class="fg"><label class="fl">Influencer Name</label><input type="text" id="f_in" placeholder="Full name"/></div>
        <div class="fg"><label class="fl">Role / Relationship</label><input type="text" id="f_ir" placeholder="e.g. Consultant, Architect"/></div>
      </div>
    </div>
    <div class="fs"><div class="fs-title">ğŸ¤ Dealer Information</div>
      <div class="fg2">
        <div class="fg"><label class="fl">Dealer Name <span class="req">*</span></label><input type="text" id="f_dn" placeholder="Dealer / distributor name"/></div>
        <div class="fg"><label class="fl">Dealer Location</label><input type="text" id="f_dl" placeholder="City"/></div>
      </div>
      <div class="fg" style="margin-top:12px"><label class="fl">Notes</label><textarea id="f_nt" placeholder="Any additional infoâ€¦"></textarea></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;padding-top:4px">
      <button class="btn btn-ghost" onclick="showPage('page-my-requests')">Cancel</button>
      <button class="btn btn-primary" onclick="submitReq()">ğŸš€ Submit Request</button>
    </div>`;
  addProdRow();
}

function addProdRow(){
  const id=++prc, w=document.getElementById('prodRows'), d=document.createElement('div');
  d.className='pr'; d.id=`pr_${id}`;
  d.innerHTML=`
    <div class="fg"><label class="fl">Product Name${id===1?'<span class="req"> *</span>':''}</label><input type="text" id="pn_${id}" placeholder="Product name"/></div>
    <div class="fg"><label class="fl">Quantity</label><input type="number" id="pq_${id}" placeholder="Qty" min="1"/></div>
    <div class="fg"><label class="fl">Pack Size</label><input type="text" id="pp_${id}" placeholder="e.g. 5kg"/></div>
    <div class="fg"><label class="fl" style="opacity:0">x</label><button class="btn btn-rej btn-sm btn-icon" onclick="rmProdRow(${id})">âœ•</button></div>`;
  w.appendChild(d);
}
function rmProdRow(id){const e=document.getElementById(`pr_${id}`);if(e&&document.getElementById('prodRows').children.length>1)e.remove();}
function getProds(){
  const ns=document.getElementById('prodRows').querySelectorAll('[id^="pn_"]'),prods=[];
  ns.forEach(inp=>{const n=inp.id.replace('pn_',''),nm=inp.value.trim();if(nm)prods.push({name:nm,qty:document.getElementById(`pq_${n}`)?.value||'',pk:document.getElementById(`pp_${n}`)?.value||''});});
  return prods;
}

async function submitReq(){
  const cn=gv('f_cn'),sn=gv('f_sn'),dn=gv('f_dn'),prods=getProds();
  if(!cn){toast('Customer Name is required','error');return;}
  if(!sn){toast('Site Name is required','error');return;}
  if(!dn){toast('Dealer Name is required','error');return;}
  if(!prods.length){toast('Add at least one product','error');return;}
  const d=load();
  const refNo=`FS-${new Date().getFullYear()}-${String(d.ctr).padStart(5,'0')}`;
  const req={
    id:'r'+Date.now(),refNo,
    custName:cn,custContact:gv('f_cc'),acctType:gv('f_at'),acctClass:gv('f_ac'),
    siteName:sn,siteAddr:gv('f_sa'),siteVal:gv('f_sv'),siteVol:gv('f_svol'),
    prods,inflName:gv('f_in'),inflRole:gv('f_ir'),
    dealerName:dn,dealerLoc:gv('f_dl'),notes:gv('f_nt'),
    status:'Pending ASM',
    submittedBy:currentUser.name, submittedByEmail:currentUser.email,
    submittedAt:new Date().toISOString(),
    asmAt:null,asmBy:null,rsmAt:null,rsmBy:null,rejReason:null,
    sapNo:null,sapAt:null,sapBy:null,
    conv:'Pending',convAt:null,convVol:null,convVal:null,convRef:null,
  };
  try { await spCreateRequest(req); } catch(e) { return; }
  // Notify ASMs
  const users=getUsers(), asms=users.filter(u=>u.role==='asm');
  asms.forEach(asm=>{
    sendNotification(asm.email, `[SampleTrack] New request ${refNo} awaiting your approval`,
      `<p>Hi ${asm.name},</p><p>A new free sample request <strong>${refNo}</strong> has been submitted by ${currentUser.name} for <strong>${cn}</strong> and requires your approval.</p><p>Please log in to SampleTrack to review.</p>`);
  });
  toast(`âœ… Request ${refNo} submitted! ASM notified.`,'success');
  showPage('page-my-requests');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  MY REQUESTS / ALL REQUESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMyRequests(){
  let d=load().requests, s=(document.getElementById('mySearch')?.value||'').toLowerCase(), sf=document.getElementById('myStatusF')?.value||'';
  d=[...d].sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
  // Sales employees only see their own requests
  if(currentUser?.role==='sales') d=d.filter(x=>x.submittedByEmail===currentUser.email);
  if(s) d=d.filter(x=>(x.refNo+x.custName+x.siteName).toLowerCase().includes(s));
  if(sf) d=d.filter(x=>x.status===sf);
  document.getElementById('myReqTitle').textContent=currentUser?.role==='sales'?`My Requests (${d.length})`:`All Requests (${d.length})`;
  document.getElementById('myReqBody').innerHTML=!d.length
    ?`<tr><td colspan="9"><div class="es"><div class="es-icon">ğŸ“­</div>No requests found</div></td></tr>`
    :d.map(x=>`<tr>
      <td class="mono" style="cursor:pointer;color:var(--teal)" onclick="openDetail('${x.id}')">${x.refNo}</td>
      <td>${esc(x.custName)}</td><td>${esc(x.siteName)}</td>
      <td style="max-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc((x.prods||[]).map(p=>p.name).join(', '))}</td>
      <td>${esc(x.dealerName)}</td><td>${sbadge(x.status)}</td>
      <td style="color:var(--ink4);font-size:12px">${fd(x.submittedAt)}</td>
      <td class="mono">${x.sapNo?`<span style="color:var(--blue)">${esc(x.sapNo)}</span>`:'<span style="color:var(--ink4)">â€”</span>'}</td>
      <td><div style="display:flex;gap:5px">
        ${currentUser?.role==='sales'&&x.status==='Fully Approved'&&!x.sapNo?`<button class="btn btn-approve btn-sm" onclick="openSAP('${x.id}')">+SAP</button>`:''}
        ${x.sapNo&&x.conv==='Pending'?`<button class="btn btn-ghost btn-sm" onclick="openConv('${x.id}')">Conv.</button>`:''}
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openDetail('${x.id}')">ğŸ‘</button>
      </div></td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  APPROVALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderApprovals(){
  const s=(document.getElementById('appSearch')?.value||'').toLowerCase();
  const role=currentUser?.role;
  let d=load().requests.filter(x=>role==='asm'?x.status==='Pending ASM':x.status==='ASM Approved');
  d=[...d].sort((a,b)=>new Date(a.submittedAt)-new Date(b.submittedAt));
  if(s)d=d.filter(x=>(x.refNo+x.custName).toLowerCase().includes(s));
  document.getElementById('appTitle').textContent=role==='asm'?`Pending ASM Approval (${d.length})`:`Pending RSM Approval (${d.length})`;
  document.getElementById('appBody').innerHTML=!d.length
    ?`<tr><td colspan="8"><div class="es"><div class="es-icon">ğŸ‰</div>No pending approvals!</div></td></tr>`
    :d.map(x=>`<tr>
      <td class="mono" style="cursor:pointer;color:var(--teal)" onclick="openDetail('${x.id}')">${x.refNo}</td>
      <td>${esc(x.custName)}</td>
      <td style="font-weight:700;color:var(--ink)">â‚¹${x.siteVal?Number(x.siteVal).toLocaleString('en-IN'):'â€”'}</td>
      <td style="max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc((x.prods||[]).map(p=>p.name).join(', '))}</td>
      <td>${esc(x.submittedBy)}</td>
      <td style="color:var(--ink4);font-size:12px">${fd(x.submittedAt)}</td>
      <td>${sbadge(x.status)}</td>
      <td><div style="display:flex;gap:5px">
        <button class="btn btn-approve btn-sm" onclick="approveReq('${x.id}')">âœ“ Approve</button>
        <button class="btn btn-rej btn-sm" onclick="openReject('${x.id}')">âœ• Reject</button>
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openDetail('${x.id}')">ğŸ‘</button>
      </div></td>
    </tr>`).join('');
}

async function approveReq(id){
  const d=load(),x=d.requests.find(r=>r.id===id); if(!x)return;
  const role=currentUser?.role;
  if(role==='asm'){
    x.status='ASM Approved'; x.asmAt=new Date().toISOString(); x.asmBy=currentUser.name;
    const rsms=getUsers().filter(u=>u.role==='rsm');
    rsms.forEach(rsm=>sendNotification(rsm.email,`[SampleTrack] ${x.refNo} awaiting RSM approval`,
      `<p>Hi ${rsm.name},</p><p>Request <strong>${x.refNo}</strong> for <strong>${x.custName}</strong> has been approved by ASM ${currentUser.name} and now awaits your approval.</p>`));
    sendNotification(x.submittedByEmail,`[SampleTrack] Your request ${x.refNo} passed ASM review`,
      `<p>Hi ${x.submittedBy},</p><p>Your sample request <strong>${x.refNo}</strong> has been approved by the ASM and is now with the RSM for final approval.</p>`);
    toast(`âœ… ${x.refNo} ASM approved. RSM notified.`,'success');
  } else if(role==='rsm'){
    x.status='Fully Approved'; x.rsmAt=new Date().toISOString(); x.rsmBy=currentUser.name;
    sendNotification(x.submittedByEmail,`[SampleTrack] âœ… ${x.refNo} fully approved â€” please create SAP order`,
      `<p>Hi ${x.submittedBy},</p><p>Great news! Your sample request <strong>${x.refNo}</strong> has received full approval. Please create the SAP order and update the SAP Order Number in SampleTrack.</p>`);
    toast(`âœ… ${x.refNo} fully approved! Submitter notified.`,'success');
  }
  try { await spUpdateRequest(x); } catch(e) { return; }
  renderApprovals(); renderNav();
}

function openReject(id){rejectId=id; document.getElementById('rejectReason').value=''; openMo('moReject');}
async function confirmReject(){
  const reason=document.getElementById('rejectReason').value.trim();
  if(!reason){toast('Provide a rejection reason','error');return;}
  const d=load(),x=d.requests.find(r=>r.id===rejectId); if(!x)return;
  x.status='Rejected'; x.rejReason=reason;
  const role=currentUser?.role;
  if(role==='asm'){x.asmAt=new Date().toISOString();x.asmBy=currentUser.name;}
  else{x.rsmAt=new Date().toISOString();x.rsmBy=currentUser.name;}
  sendNotification(x.submittedByEmail,`[SampleTrack] âŒ Request ${x.refNo} was rejected`,
    `<p>Hi ${x.submittedBy},</p><p>Your request <strong>${x.refNo}</strong> has been rejected by ${currentUser.name}.</p><p><strong>Reason:</strong> ${reason}</p><p>You may revise and resubmit if needed.</p>`);
  try { await spUpdateRequest(x); } catch(e) { return; }
  closeMo('moReject'); toast(`âŒ ${x.refNo} rejected. Submitter notified.`,'error'); renderApprovals(); renderNav();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  SAP TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTracker(){
  const s=(document.getElementById('sapSearch')?.value||'').toLowerCase(), fv=document.getElementById('sapF')?.value||'';
  let d=load().requests.filter(x=>x.status==='Fully Approved'||x.sapNo);
  d=[...d].sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
  if(fv==='needs')d=d.filter(x=>!x.sapNo);
  if(fv==='done')d=d.filter(x=>x.sapNo);
  if(s)d=d.filter(x=>(x.refNo+x.custName).toLowerCase().includes(s));
  document.getElementById('sapBody').innerHTML=!d.length
    ?`<tr><td colspan="7"><div class="es"><div class="es-icon">ğŸ“¦</div>No approved requests yet</div></td></tr>`
    :d.map(x=>`<tr>
      <td class="mono" style="cursor:pointer;color:var(--teal)" onclick="openDetail('${x.id}')">${x.refNo}</td>
      <td>${esc(x.custName)}</td>
      <td style="max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc((x.prods||[]).map(p=>p.name).join(', '))}</td>
      <td style="font-size:12px;color:var(--ink4)">${fd(x.rsmAt||x.submittedAt)}</td>
      <td class="mono">${x.sapNo?`<span style="color:var(--blue);font-weight:600">${esc(x.sapNo)}</span>`:`<span style="color:var(--amber)">Not set</span>`}</td>
      <td style="font-size:12px;color:var(--ink4)">${x.sapBy?esc(x.sapBy):'â€”'}</td>
      <td>${!x.sapNo&&currentUser?.role==='sales'?`<button class="btn btn-approve btn-sm" onclick="openSAP('${x.id}')">+ Add SAP #</button>`:x.sapNo?`<span class="badge sap-linked">SAP Linked</span>`:''}</td>
    </tr>`).join('');
}

function openSAP(id){sapId=id; document.getElementById('sapInput').value=''; openMo('moSAP');}
async function confirmSAP(){
  const num=document.getElementById('sapInput').value.trim();
  if(!num){toast('Enter SAP Order Number','error');return;}
  const d=load(),x=d.requests.find(r=>r.id===sapId); if(!x)return;
  x.sapNo=num; x.status='SAP Linked'; x.sapAt=new Date().toISOString(); x.sapBy=currentUser.name;
  try { await spUpdateRequest(x); } catch(e) { return; }
  closeMo('moSAP'); toast(`ğŸ”— SAP ${num} linked to ${x.refNo}`,'success'); renderTracker(); renderNav();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  CONVERSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderConversion(){
  const s=(document.getElementById('convSearch')?.value||'').toLowerCase(), fv=document.getElementById('convF')?.value||'';
  let d=load().requests.filter(x=>x.sapNo);
  d=[...d].sort((a,b)=>new Date(b.sapAt)-new Date(a.sapAt));
  if(fv)d=d.filter(x=>x.conv===fv);
  if(s)d=d.filter(x=>(x.refNo+x.custName).toLowerCase().includes(s));
  document.getElementById('convBody').innerHTML=!d.length
    ?`<tr><td colspan="9"><div class="es"><div class="es-icon">ğŸ“ˆ</div>No SAP-linked requests yet</div></td></tr>`
    :d.map(x=>`<tr>
      <td class="mono" style="cursor:pointer;color:var(--teal)" onclick="openDetail('${x.id}')">${x.refNo}</td>
      <td>${esc(x.custName)}</td>
      <td>â‚¹${x.siteVal?Number(x.siteVal).toLocaleString('en-IN'):'â€”'}</td>
      <td class="mono">${esc(x.sapNo||'â€”')}</td>
      <td>${cbadge(x.conv)}</td>
      <td class="mono">${x.convRef?esc(x.convRef):'<span style="color:var(--ink4)">â€”</span>'}</td>
      <td>${x.convVol?Number(x.convVol).toLocaleString():'â€”'}</td>
      <td>${x.convVal?'â‚¹'+Number(x.convVal).toLocaleString('en-IN'):'â€”'}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="openConv('${x.id}')">Update</button></td>
    </tr>`).join('');
}

function openConv(id){
  convId=id; const d=load(),x=d.requests.find(r=>r.id===id);
  document.getElementById('convOutcome').value=x?.conv||'Pending';
  document.getElementById('convVol').value=x?.convVol||'';
  document.getElementById('convVal').value=x?.convVal||'';
  document.getElementById('convSAPRef').value=x?.convRef||'';
  toggleConvF(); openMo('moConv');
}
function toggleConvF(){document.getElementById('convFields').style.display=document.getElementById('convOutcome').value==='Converted'?'block':'none';}
async function confirmConv(){
  const outcome=document.getElementById('convOutcome').value;
  const d=load(),x=d.requests.find(r=>r.id===convId); if(!x)return;
  x.conv=outcome; x.convAt=new Date().toISOString(); x.convBy=currentUser.name;
  if(outcome==='Converted'){x.convVol=document.getElementById('convVol').value;x.convVal=document.getElementById('convVal').value;x.convRef=document.getElementById('convSAPRef').value;}
  try { await spUpdateRequest(x); } catch(e) { return; }
  closeMo('moConv'); toast(outcome==='Converted'?'ğŸ‰ Conversion recorded!':'ğŸ“ Status updated','success'); renderConversion();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin(){
  const s=(document.getElementById('adminSearch')?.value||'').toLowerCase();
  let users=getUsers();
  if(s) users=users.filter(u=>(u.name+u.email+u.dept).toLowerCase().includes(s));
  const roleColors={sales:'var(--teal)',asm:'var(--violet)',rsm:'var(--blue)',admin:'var(--amber)'};
  document.getElementById('adminBody').innerHTML=!users.length
    ?`<tr><td colspan="6"><div class="es"><div class="es-icon">ğŸ‘¤</div>No users added yet</div></td></tr>`
    :users.map(u=>`<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="user-avatar-sm" style="background:${roleColors[u.role]||'var(--ink3)'}">${u.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2)}</div>
        <span style="font-weight:600;color:var(--ink)">${esc(u.name)}</span>
      </div></td>
      <td class="mono" style="font-size:12px">${esc(u.email)}</td>
      <td style="color:var(--ink3)">${esc(u.dept||'â€”')}</td>
      <td>
        <select class="role-select-inline" onchange="updateUserRole('${u.email}', this.value)">
          <option value="sales"${u.role==='sales'?' selected':''}>Sales Employee</option>
          <option value="asm"${u.role==='asm'?' selected':''}>Area Sales Manager</option>
          <option value="rsm"${u.role==='rsm'?' selected':''}>Regional Sales Manager</option>
          <option value="admin"${u.role==='admin'?' selected':''}>Admin</option>
        </select>
      </td>
      <td style="color:var(--ink4);font-size:12px">${u.lastLogin?fd(u.lastLogin):'Never'}</td>
      <td><button class="btn btn-rej btn-sm btn-icon" onclick="removeUser('${u.email}')" title="Remove user">âœ•</button></td>
    </tr>`).join('');

  // Config form
  const cfg=getCfg();
  if(document.getElementById('cfg_tenant')) document.getElementById('cfg_tenant').value=cfg.tenantId||CONFIG.tenantId!=='YOUR_TENANT_ID'?CONFIG.tenantId:'';
  if(document.getElementById('cfg_client')) document.getElementById('cfg_client').value=cfg.clientId||CONFIG.clientId!=='YOUR_CLIENT_ID'?CONFIG.clientId:'';
  if(document.getElementById('cfg_sp')) document.getElementById('cfg_sp').value=cfg.spSiteUrl||CONFIG.spSiteUrl!=='https://mrfvapocurepaint.sharepoint.com/sites/SampleTrack'?CONFIG.spSiteUrl:'';
  if(document.getElementById('cfg_list')) document.getElementById('cfg_list').value=cfg.spListName||CONFIG.spListName||'SampleRequests';

  // Checklist
  document.getElementById('setupChecklist').innerHTML=[
    {done:IS_CONFIGURED, label:'Register app in Azure AD (App Registration)', detail:'Azure Portal â†’ Azure AD â†’ App Registrations â†’ New Registration'},
    {done:IS_CONFIGURED, label:'Set Tenant ID & Client ID in app config', detail:'Replace YOUR_TENANT_ID and YOUR_CLIENT_ID at the top of this HTML file'},
    {done:false, label:'Add redirect URI to Azure AD app', detail:`https://mrfpaint.github.io/Sampletrack`},
    {done:false, label:'Grant API permissions in Azure AD', detail:'Microsoft Graph: User.Read, Sites.ReadWrite.All, Mail.Send'},
    {done:false, label:'Create SharePoint List "SampleRequests"', detail:'In your SharePoint site, create a list with the required columns'},
    {done:false, label:'Upload this file to SharePoint as a web part', detail:'Use a Script Editor or SPFx web part to embed this HTML'},
    {done:getUsers().length>1, label:'Add employees & assign roles in Admin Panel', detail:'Use the table above to register employees and set their roles'},
  ].map(item=>`
    <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--surface2)">
      <div style="width:20px;height:20px;border-radius:50%;background:${item.done?'var(--teal)':'var(--surface2)'};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;color:${item.done?'#fff':'var(--ink4)'};margin-top:1px">${item.done?'âœ“':'â—‹'}</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:${item.done?'var(--teal-dark)':'var(--ink)'};font-family:'Syne',sans-serif">${item.label}</div>
        <div style="font-size:11.5px;color:var(--ink4);margin-top:1px">${item.detail}</div>
      </div>
    </div>`).join('');
}

function updateUserRole(email, newRole){
  const users=getUsers(), u=users.find(x=>x.email.toLowerCase()===email.toLowerCase());
  if(!u) return;
  u.role=newRole;
  spSaveUser(u).then(()=>toast(`âœ… ${u.name} set as ${roleLabel(newRole)}`,'success')).catch(e=>toast('Role update failed: '+e.message,'error'));
  renderNav();
}

function removeUser(email){
  spDeleteUser(email).then(()=>{ renderAdmin(); toast('User removed','info'); }).catch(e=>toast('Remove failed: '+e.message,'error'));
}

function openAddUserModal(){
  document.getElementById('au_name').value='';
  document.getElementById('au_email').value='';
  document.getElementById('au_dept').value='';
  document.getElementById('au_role').value='sales';
  openMo('moAddUser');
}
async function confirmAddUser(){
  const name=gv('au_name'),email=gv('au_email'),dept=gv('au_dept'),role=document.getElementById('au_role').value;
  if(!name||!email){toast('Name and email are required','error');return;}
  const users=getUsers();
  const existing=users.findIndex(u=>u.email.toLowerCase()===email.toLowerCase());
  const existing_user = _users.find(u=>u.email.toLowerCase()===email.toLowerCase());
  const record = existing_user ? {...existing_user, name, dept, role} : {name,email,dept,role,lastLogin:null};
  try { await spSaveUser(record); } catch(e) { return; }
  closeMo('moAddUser'); renderAdmin(); toast(`âœ… ${name} added as ${roleLabel(role)}`,'success');
}

function saveConfig(){
  const cfg={tenantId:gv('cfg_tenant'),clientId:gv('cfg_client'),spSiteUrl:gv('cfg_sp'),spListName:gv('cfg_list')};
  saveCfg(cfg); toast('âš™ï¸ Configuration saved. Reload the page to apply.','success');
}

async function testSPConnection(){
  const st=document.getElementById('connStatus');
  st.textContent='Testingâ€¦'; st.style.color='var(--ink4)';
  if(!IS_CONFIGURED){st.textContent='âŒ Azure AD not configured';st.style.color='var(--red)';return;}
  try{
    const accounts=msalInstance?.getAllAccounts()||[];
    if(!accounts.length){st.textContent='âŒ Not signed in with M365';st.style.color='var(--red)';return;}
    const token=await msalInstance.acquireTokenSilent({scopes:['Sites.ReadWrite.All'],account:accounts[0]});
    const url=`${gv('cfg_sp')}/_api/web/title`;
    const r=await fetch(url,{headers:{Authorization:`Bearer ${token.accessToken}`,Accept:'application/json;odata=nometadata'}});
    if(r.ok){const data=await r.json();st.textContent=`âœ… Connected: ${data.value}`;st.style.color='var(--teal)';}
    else{st.textContent=`âŒ HTTP ${r.status}`;st.style.color='var(--red)';}
  }catch(e){st.textContent='âŒ '+e.message;st.style.color='var(--red)';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id){
  const d=load(), x=d.requests.find(r=>r.id===id); if(!x) return;
  document.getElementById('moDetailTitle').textContent=`${x.refNo} â€” ${x.custName}`;
  const prog=getProgSteps(x);
  let html=`<div class="prog">${prog.map(p=>`
    <div class="ps ${p.st}"><div class="pd ${p.st}">${p.ic}</div><div class="pl">${p.lb}</div></div>`).join('')}</div>`;
  if(x.rejReason) html+=`<div class="rnote"><div class="rnote-icon">âš ï¸</div><div class="rnote-text"><strong>Rejected:</strong> ${esc(x.rejReason)}</div></div>`;
  html+=`<div class="sdiv">Customer & Site</div>
  <div class="dg">
    <div class="di"><div class="dl">Customer</div><div class="dv">${esc(x.custName)}</div></div>
    <div class="di"><div class="dl">Contact</div><div class="dv">${esc(x.custContact||'â€”')}</div></div>
    <div class="di"><div class="dl">Account</div><div class="dv">${esc(x.acctType||'â€”')} Â· Class ${esc(x.acctClass||'â€”')}</div></div>
    <div class="di"><div class="dl">Site</div><div class="dv">${esc(x.siteName)}${x.siteAddr?` Â· ${esc(x.siteAddr)}`:''}</div></div>
    <div class="di"><div class="dl">Potential Value</div><div class="dv" style="font-weight:700;color:var(--teal)">â‚¹${x.siteVal?Number(x.siteVal).toLocaleString('en-IN'):'â€”'}</div></div>
    <div class="di"><div class="dl">Est. Volume</div><div class="dv">${x.siteVol?x.siteVol+' units/mo':'â€”'}</div></div>
  </div>
  <div class="sdiv">Products</div>
  <div style="background:var(--surface);border-radius:9px;overflow:hidden;margin-bottom:16px">
    <table><thead><tr><th>Product</th><th>Qty</th><th>Pack Size</th></tr></thead>
    <tbody>${(x.prods||[]).map(p=>`<tr><td>${esc(p.name)}</td><td>${esc(p.qty||'â€”')}</td><td>${esc(p.pk||'â€”')}</td></tr>`).join('')}</tbody></table></div>
  <div class="dg">
    ${x.inflName?`<div class="di"><div class="dl">Influencer</div><div class="dv">${esc(x.inflName)}${x.inflRole?' Â· '+esc(x.inflRole):''}</div></div>`:''}
    <div class="di"><div class="dl">Dealer</div><div class="dv">${esc(x.dealerName)}${x.dealerLoc?' Â· '+esc(x.dealerLoc):''}</div></div>
    <div class="di"><div class="dl">Submitted By</div><div class="dv">${esc(x.submittedBy||'â€”')}</div></div>
    ${x.notes?`<div class="di df"><div class="dl">Notes</div><div class="dv">${esc(x.notes)}</div></div>`:''}
  </div>
  <div class="sdiv">Approval & Tracking Timeline</div>
  <div class="tl">
    ${tli('ğŸ“‹','done','Request Submitted',fdf(x.submittedAt)+` by ${esc(x.submittedBy||'â€”')}`)}
    ${tli(x.asmAt?(x.status==='Rejected'&&!x.rsmAt?'âœ•':'âœ“'):'âŒ›',x.asmAt?(x.status==='Rejected'&&!x.rsmAt?'rej':'done'):'pend','ASM Review',x.asmAt?fdf(x.asmAt)+` by ${esc(x.asmBy||'ASM')}`:'Pending')}
    ${tli(x.rsmAt?(x.status==='Rejected'?'âœ•':'âœ“'):(x.status==='ASM Approved'?'âŒ›':'â—‹'),x.rsmAt?(x.status==='Rejected'?'rej':'done'):(x.status==='ASM Approved'?'pend':'gray'),'RSM Review',x.rsmAt?fdf(x.rsmAt)+` by ${esc(x.rsmBy||'RSM')}`:(x.status==='ASM Approved'?'Pending RSM':'Waiting for ASM approval first'))}
    ${tli(x.sapNo?'ğŸ”—':(x.status==='Fully Approved'?'âŒ›':'â—‹'),x.sapNo?'done':(x.status==='Fully Approved'?'pend':'gray'),'SAP Order Created',x.sapNo?`Order #${x.sapNo} Â· ${fdf(x.sapAt)} by ${esc(x.sapBy||'â€”')}`:(x.status==='Fully Approved'?'Awaiting SAP number':'â€”'))}
    ${tli(x.conv==='Converted'?'ğŸ‰':(x.conv==='Not Converted'?'âœ•':(x.sapNo?'âŒ›':'â—‹')),x.conv==='Converted'?'done':(x.conv==='Not Converted'?'rej':(x.sapNo?'pend':'gray')),'Conversion',x.conv==='Converted'?`Converted Â· Vol: ${x.convVol||'â€”'} Â· â‚¹${x.convVal?Number(x.convVal).toLocaleString('en-IN'):'â€”'} Â· SAP: ${x.convRef||'â€”'}`:(x.conv==='Not Converted'?'Not converted':x.sapNo?'Pending update':'â€”'))}
  </div>`;
  document.getElementById('moDetailBody').innerHTML=html;
  const role=currentUser?.role;
  let foot=`<button class="btn btn-ghost" onclick="closeMo('moDetail')">Close</button>`;
  if(role==='asm'&&x.status==='Pending ASM') foot+=`<button class="btn btn-rej" onclick="openReject('${x.id}');closeMo('moDetail')">âœ• Reject</button><button class="btn btn-approve" onclick="approveReq('${x.id}');closeMo('moDetail')">âœ“ ASM Approve</button>`;
  if(role==='rsm'&&x.status==='ASM Approved') foot+=`<button class="btn btn-rej" onclick="openReject('${x.id}');closeMo('moDetail')">âœ• Reject</button><button class="btn btn-approve" onclick="approveReq('${x.id}');closeMo('moDetail')">âœ“ RSM Approve</button>`;
  if(role==='sales'&&x.status==='Fully Approved'&&!x.sapNo) foot+=`<button class="btn btn-primary" onclick="openSAP('${x.id}');closeMo('moDetail')">ğŸ”— Add SAP #</button>`;
  if(x.sapNo) foot+=`<button class="btn btn-ghost" onclick="openConv('${x.id}');closeMo('moDetail')">ğŸ“ˆ Update Conversion</button>`;
  document.getElementById('moDetailFoot').innerHTML=foot;
  openMo('moDetail');
}

function getProgSteps(x){
  return[
    {lb:'Submitted',ic:'1',st:'done'},
    {lb:'ASM Review',ic:'2',st:x.asmAt?(x.status==='Rejected'&&!x.rsmAt?'rejected':'done'):'active'},
    {lb:'RSM Review',ic:'3',st:x.rsmAt?(x.status==='Rejected'?'rejected':'done'):(x.asmAt&&x.status!=='Rejected'?'active':'inactive')},
    {lb:'SAP Order',ic:'4',st:x.sapNo?'done':(x.status==='Fully Approved'?'active':'inactive')},
    {lb:'Conversion',ic:'5',st:x.conv==='Converted'?'done':(x.conv==='Not Converted'?'rejected':(x.sapNo?'active':'inactive'))},
  ];
}

function tli(ic,st,title,sub){
  return`<div class="tli"><div class="tl-line"></div><div class="tld ${st}">${ic}</div><div class="tlc"><div class="tlt">${title}</div><div class="tls">${sub}</div></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sbadge(s){const m={'Pending ASM':'pending','ASM Approved':'asm-approved','Fully Approved':'fully-approved','Rejected':'rejected','SAP Linked':'sap-linked'};return`<span class="badge ${m[s]||'pending'}">${s}</span>`;}
function cbadge(c){const m={'Converted':'converted','Not Converted':'not-converted','Pending':'pending'};return`<span class="badge ${m[c]||'pending'}">${c}</span>`;}
function fd(s){if(!s)return'â€”';return new Date(s).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'2-digit'});}
function fdf(s){if(!s)return'â€”';return new Date(s).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function gv(id){return document.getElementById(id)?.value?.trim()||'';}
function roleLabel(r){return{sales:'Sales Employee',asm:'Area Sales Manager',rsm:'Regional Sales Manager',admin:'Administrator'}[r]||r;}
function openMo(id){document.getElementById(id)?.classList.add('open');}
function closeMo(id){document.getElementById(id)?.classList.remove('open');}
function toast(msg,type=''){
  const w=document.getElementById('toastWrap'),t=document.createElement('div');
  t.className=`toast ${type}`;t.innerHTML=`<span>${msg}</span>`;w.appendChild(t);
  setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),260);},3500);
}
document.querySelectorAll('.mo').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  SEED + INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seed(){
  const raw = localStorage.getItem('fsms_demo');
  const d = raw ? JSON.parse(raw) : {requests:[],ctr:1};
  if(d.requests.length>0)return;
  const ago=n=>new Date(Date.now()-n*86400000).toISOString();
  d.requests=[
    {id:'r1',refNo:'FS-2025-00001',custName:'Apex Constructions',custContact:'Ramesh Kumar Â· 9876543210',acctType:'Direct',acctClass:'A',siteName:'Apex Tower, Whitefield',siteAddr:'Bengaluru',siteVal:'750000',siteVol:'300',prods:[{name:'UltraSeal WB',qty:'10',pk:'20L'},{name:'AquaBlock Plus',qty:'5',pk:'5kg'}],inflName:'Suresh Patel',inflRole:'Architect',dealerName:'SriRam Paints & Hardware',dealerLoc:'Whitefield',notes:'Priority site',status:'SAP Linked',submittedBy:'Arjun R. (Sales)',submittedByEmail:'arjun@demo.com',submittedAt:ago(10),asmAt:ago(9),asmBy:'Priya S. (ASM)',rsmAt:ago(8),rsmBy:'Anil M. (RSM)',rejReason:null,sapNo:'5000123456',sapAt:ago(6),sapBy:'Arjun R.',conv:'Converted',convAt:ago(2),convVol:'280',convVal:'210000',convRef:'4900098712'},
    {id:'r2',refNo:'FS-2025-00002',custName:'Metro Realty Ltd',custContact:'Deepa Nair',acctType:'Institutional',acctClass:'A',siteName:'Metro Heights Phase 2',siteAddr:'Hyderabad',siteVal:'1200000',siteVol:'500',prods:[{name:'FlexCoat Pro',qty:'20',pk:'10L'}],inflName:'',inflRole:'',dealerName:'Hyd Building Supplies',dealerLoc:'Kukatpally',notes:'',status:'ASM Approved',submittedBy:'Sunita K. (Sales)',submittedByEmail:'sunita@demo.com',submittedAt:ago(5),asmAt:ago(4),asmBy:'Priya S. (ASM)',rsmAt:null,rsmBy:null,rejReason:null,sapNo:null,sapAt:null,sapBy:null,conv:'Pending',convAt:null,convVol:null,convVal:null,convRef:null},
    {id:'r3',refNo:'FS-2025-00003',custName:'BuildRight Infra',custContact:'Arvind Sharma',acctType:'Distributor',acctClass:'B',siteName:'NH-44 Highway Project',siteAddr:'Chennai',siteVal:'400000',siteVol:'150',prods:[{name:'CrackFill Ultra',qty:'8',pk:'2kg'}],inflName:'',inflRole:'',dealerName:'Chennai Paints Hub',dealerLoc:'Ambattur',notes:'',status:'Pending ASM',submittedBy:'Demo User',submittedByEmail:'demo@mrfpaint.com',submittedAt:ago(2),asmAt:null,asmBy:null,rsmAt:null,rsmBy:null,rejReason:null,sapNo:null,sapAt:null,sapBy:null,conv:'Pending',convAt:null,convVol:null,convVal:null,convRef:null},
    {id:'r4',refNo:'FS-2025-00004',custName:'GreenLeaf Developers',custContact:'Meena Iyer',acctType:'Direct',acctClass:'B',siteName:'GreenLeaf Villa Township',siteAddr:'Coimbatore',siteVal:'300000',siteVol:'100',prods:[{name:'ThermoShield HT',qty:'6',pk:'20L'}],inflName:'Vikram Nair',inflRole:'Civil Engineer',dealerName:'Kovai Hardware Depot',dealerLoc:'Coimbatore',notes:'',status:'Rejected',submittedBy:'Demo User',submittedByEmail:'demo@mrfpaint.com',submittedAt:ago(7),asmAt:ago(6),asmBy:'Priya S. (ASM)',rsmAt:null,rsmBy:null,rejReason:'Insufficient site potential. Please reassess and resubmit.',sapNo:null,sapAt:null,sapBy:null,conv:'Pending',convAt:null,convVol:null,convVal:null,convRef:null},
    {id:'r5',refNo:'FS-2025-00005',custName:'Stellar Homes Pvt Ltd',custContact:'Rahul Verma',acctType:'Direct',acctClass:'A',siteName:'Stellar Skyline Tower',siteAddr:'Pune',siteVal:'950000',siteVol:'400',prods:[{name:'UltraSeal WB',qty:'15',pk:'20L'},{name:'FlexCoat Pro',qty:'10',pk:'10L'}],inflName:'',inflRole:'',dealerName:'Pune Pro Supplies',dealerLoc:'Hadapsar',notes:'',status:'Fully Approved',submittedBy:'Demo User',submittedByEmail:'demo@mrfpaint.com',submittedAt:ago(3),asmAt:ago(2),asmBy:'Priya S. (ASM)',rsmAt:ago(1),rsmBy:'Anil M. (RSM)',rejReason:null,sapNo:null,sapAt:null,sapBy:null,conv:'Pending',convAt:null,convVol:null,convVal:null,convRef:null},
  ]; d.ctr=6; localStorage.setItem('fsms_demo', JSON.stringify(d));
}

// Seed demo users
function seedUsers(){
  const raw = localStorage.getItem('fsms_demo_users');
  const u = raw ? JSON.parse(raw) : [];
  if(u.length>1) return;
  const users = [
    {name:'Demo User',email:'demo@mrfpaint.com',dept:'Admin',role:'admin',lastLogin:new Date().toISOString()},
    {name:'Arjun Ramesh',email:'arjun@mrfpaint.com',dept:'Sales â€“ South Zone',role:'sales',lastLogin:null},
    {name:'Sunita Krishnan',email:'sunita@mrfpaint.com',dept:'Sales â€“ West Zone',role:'sales',lastLogin:null},
    {name:'Priya Sharma',email:'priya@mrfpaint.com',dept:'Sales Management',role:'asm',lastLogin:null},
    {name:'Anil Mehta',email:'anil@mrfpaint.com',dept:'Regional Management',role:'rsm',lastLogin:null},
  ];
  localStorage.setItem('fsms_demo_users', JSON.stringify(users));
}

// Seed only runs in demo mode - SP is the live data store
// initMSAL() is called by msal.min.js onload handler above
</script>
</body>
</html>
